//
// List borrowed from google block list extension
// ==UserScript==
// @include http*://encrypted.google.com/
// @include http*://encrypted.google.com/search*
// @include http*://encrypted.google.com/webhp*
// @include http*://www.google.ad/
// @include http*://www.google.ad/search*
// @include http*://www.google.ad/webhp*
// @include http*://www.google.ae/
// @include http*://www.google.ae/search*
// @include http*://www.google.ae/webhp*
// @include http*://www.google.am/
// @include http*://www.google.am/search*
// @include http*://www.google.am/webhp*
// @include http*://www.google.as/
// @include http*://www.google.as/search*
// @include http*://www.google.as/webhp*
// @include http*://www.google.at/
// @include http*://www.google.at/search*
// @include http*://www.google.at/webhp*
// @include http*://www.google.az/
// @include http*://www.google.az/search*
// @include http*://www.google.az/webhp*
// @include http*://www.google.ba/
// @include http*://www.google.ba/search*
// @include http*://www.google.ba/webhp*
// @include http*://www.google.be/
// @include http*://www.google.be/search*
// @include http*://www.google.be/webhp*
// @include http*://www.google.bf/
// @include http*://www.google.bf/search*
// @include http*://www.google.bf/webhp*
// @include http*://www.google.bg/
// @include http*://www.google.bg/search*
// @include http*://www.google.bg/webhp*
// @include http*://www.google.bi/
// @include http*://www.google.bi/search*
// @include http*://www.google.bi/webhp*
// @include http*://www.google.bj/
// @include http*://www.google.bj/search*
// @include http*://www.google.bj/webhp*
// @include http*://www.google.bs/
// @include http*://www.google.bs/search*
// @include http*://www.google.bs/webhp*
// @include http*://www.google.by/
// @include http*://www.google.by/search*
// @include http*://www.google.by/webhp*
// @include http*://www.google.ca/
// @include http*://www.google.ca/search*
// @include http*://www.google.ca/webhp*
// @include http*://www.google.cat/
// @include http*://www.google.cat/search*
// @include http*://www.google.cat/webhp*
// @include http*://www.google.cd/
// @include http*://www.google.cd/search*
// @include http*://www.google.cd/webhp*
// @include http*://www.google.cf/
// @include http*://www.google.cf/search*
// @include http*://www.google.cf/webhp*
// @include http*://www.google.cg/
// @include http*://www.google.cg/search*
// @include http*://www.google.cg/webhp*
// @include http*://www.google.ch/
// @include http*://www.google.ch/search*
// @include http*://www.google.ch/webhp*
// @include http*://www.google.ci/
// @include http*://www.google.ci/search*
// @include http*://www.google.ci/webhp*
// @include http*://www.google.cl/
// @include http*://www.google.cl/search*
// @include http*://www.google.cl/webhp*
// @include http*://www.google.cm/
// @include http*://www.google.cm/search*
// @include http*://www.google.cm/webhp*
// @include http*://www.google.cn/
// @include http*://www.google.cn/search*
// @include http*://www.google.cn/webhp*
// @include http*://www.google.co.bw/
// @include http*://www.google.co.bw/search*
// @include http*://www.google.co.bw/webhp*
// @include http*://www.google.co.ck/
// @include http*://www.google.co.ck/search*
// @include http*://www.google.co.ck/webhp*
// @include http*://www.google.co.cr/
// @include http*://www.google.co.cr/search*
// @include http*://www.google.co.cr/webhp*
// @include http*://www.google.co.id/
// @include http*://www.google.co.id/search*
// @include http*://www.google.co.id/webhp*
// @include http*://www.google.co.il/
// @include http*://www.google.co.il/search*
// @include http*://www.google.co.il/webhp*
// @include http*://www.google.co.in/
// @include http*://www.google.co.in/search*
// @include http*://www.google.co.in/webhp*
// @include http*://www.google.co.jp/
// @include http*://www.google.co.jp/search*
// @include http*://www.google.co.jp/webhp*
// @include http*://www.google.co.ke/
// @include http*://www.google.co.ke/search*
// @include http*://www.google.co.ke/webhp*
// @include http*://www.google.co.kr/
// @include http*://www.google.co.kr/search*
// @include http*://www.google.co.kr/webhp*
// @include http*://www.google.co.ls/
// @include http*://www.google.co.ls/search*
// @include http*://www.google.co.ls/webhp*
// @include http*://www.google.co.ma/
// @include http*://www.google.co.ma/search*
// @include http*://www.google.co.ma/webhp*
// @include http*://www.google.co.mz/
// @include http*://www.google.co.mz/search*
// @include http*://www.google.co.mz/webhp*
// @include http*://www.google.co.nz/
// @include http*://www.google.co.nz/search*
// @include http*://www.google.co.nz/webhp*
// @include http*://www.google.co.th/
// @include http*://www.google.co.th/search*
// @include http*://www.google.co.th/webhp*
// @include http*://www.google.co.tz/
// @include http*://www.google.co.tz/search*
// @include http*://www.google.co.tz/webhp*
// @include http*://www.google.co.ug/
// @include http*://www.google.co.ug/search*
// @include http*://www.google.co.ug/webhp*
// @include http*://www.google.co.uk/
// @include http*://www.google.co.uk/search*
// @include http*://www.google.co.uk/webhp*
// @include http*://www.google.co.uz/
// @include http*://www.google.co.uz/search*
// @include http*://www.google.co.uz/webhp*
// @include http*://www.google.co.ve/
// @include http*://www.google.co.ve/search*
// @include http*://www.google.co.ve/webhp*
// @include http*://www.google.co.vi/
// @include http*://www.google.co.vi/search*
// @include http*://www.google.co.vi/webhp*
// @include http*://www.google.co.za/
// @include http*://www.google.co.za/search*
// @include http*://www.google.co.za/webhp*
// @include http*://www.google.co.zm/
// @include http*://www.google.co.zm/search*
// @include http*://www.google.co.zm/webhp*
// @include http*://www.google.co.zw/
// @include http*://www.google.co.zw/search*
// @include http*://www.google.co.zw/webhp*
// @include http*://www.google.com/
// @include http*://www.google.com/webhp*
// @include http*://www.google.com/search*
// @include http*://www.google.com.af/
// @include http*://www.google.com.af/search*
// @include http*://www.google.com.af/webhp*
// @include http*://www.google.com.ag/
// @include http*://www.google.com.ag/search*
// @include http*://www.google.com.ag/webhp*
// @include http*://www.google.com.ai/
// @include http*://www.google.com.ai/search*
// @include http*://www.google.com.ai/webhp*
// @include http*://www.google.com.ar/
// @include http*://www.google.com.ar/search*
// @include http*://www.google.com.ar/webhp*
// @include http*://www.google.com.au/
// @include http*://www.google.com.au/search*
// @include http*://www.google.com.au/webhp*
// @include http*://www.google.com.bd/
// @include http*://www.google.com.bd/search*
// @include http*://www.google.com.bd/webhp*
// @include http*://www.google.com.bh/
// @include http*://www.google.com.bh/search*
// @include http*://www.google.com.bh/webhp*
// @include http*://www.google.com.bn/
// @include http*://www.google.com.bn/search*
// @include http*://www.google.com.bn/webhp*
// @include http*://www.google.com.bo/
// @include http*://www.google.com.bo/search*
// @include http*://www.google.com.bo/webhp*
// @include http*://www.google.com.br/
// @include http*://www.google.com.br/search*
// @include http*://www.google.com.br/webhp*
// @include http*://www.google.com.by/
// @include http*://www.google.com.by/search*
// @include http*://www.google.com.by/webhp*
// @include http*://www.google.com.bz/
// @include http*://www.google.com.bz/search*
// @include http*://www.google.com.bz/webhp*
// @include http*://www.google.com.co/
// @include http*://www.google.com.co/search*
// @include http*://www.google.com.co/webhp*
// @include http*://www.google.com.cu/
// @include http*://www.google.com.cu/search*
// @include http*://www.google.com.cu/webhp*
// @include http*://www.google.com.do/
// @include http*://www.google.com.do/search*
// @include http*://www.google.com.do/webhp*
// @include http*://www.google.com.ec/
// @include http*://www.google.com.ec/search*
// @include http*://www.google.com.ec/webhp*
// @include http*://www.google.com.eg/
// @include http*://www.google.com.eg/search*
// @include http*://www.google.com.eg/webhp*
// @include http*://www.google.com.et/
// @include http*://www.google.com.et/search*
// @include http*://www.google.com.et/webhp*
// @include http*://www.google.com.fj/
// @include http*://www.google.com.fj/search*
// @include http*://www.google.com.fj/webhp*
// @include http*://www.google.com.gh/
// @include http*://www.google.com.gh/search*
// @include http*://www.google.com.gh/webhp*
// @include http*://www.google.com.gi/
// @include http*://www.google.com.gi/search*
// @include http*://www.google.com.gi/webhp*
// @include http*://www.google.com.gt/
// @include http*://www.google.com.gt/search*
// @include http*://www.google.com.gt/webhp*
// @include http*://www.google.com.hk/
// @include http*://www.google.com.hk/search*
// @include http*://www.google.com.hk/webhp*
// @include http*://www.google.com.jm/
// @include http*://www.google.com.jm/search*
// @include http*://www.google.com.jm/webhp*
// @include http*://www.google.com.kh/
// @include http*://www.google.com.kh/search*
// @include http*://www.google.com.kh/webhp*
// @include http*://www.google.com.kw/
// @include http*://www.google.com.kw/search*
// @include http*://www.google.com.kw/webhp*
// @include http*://www.google.com.lb/
// @include http*://www.google.com.lb/search*
// @include http*://www.google.com.lb/webhp*
// @include http*://www.google.com.ly/
// @include http*://www.google.com.ly/search*
// @include http*://www.google.com.ly/webhp*
// @include http*://www.google.com.mt/
// @include http*://www.google.com.mt/search*
// @include http*://www.google.com.mt/webhp*
// @include http*://www.google.com.mx/
// @include http*://www.google.com.mx/search*
// @include http*://www.google.com.mx/webhp*
// @include http*://www.google.com.my/
// @include http*://www.google.com.my/search*
// @include http*://www.google.com.my/webhp*
// @include http*://www.google.com.na/
// @include http*://www.google.com.na/search*
// @include http*://www.google.com.na/webhp*
// @include http*://www.google.com.nf/
// @include http*://www.google.com.nf/search*
// @include http*://www.google.com.nf/webhp*
// @include http*://www.google.com.ng/
// @include http*://www.google.com.ng/search*
// @include http*://www.google.com.ng/webhp*
// @include http*://www.google.com.ni/
// @include http*://www.google.com.ni/search*
// @include http*://www.google.com.ni/webhp*
// @include http*://www.google.com.np/
// @include http*://www.google.com.np/search*
// @include http*://www.google.com.np/webhp*
// @include http*://www.google.com.om/
// @include http*://www.google.com.om/search*
// @include http*://www.google.com.om/webhp*
// @include http*://www.google.com.pa/
// @include http*://www.google.com.pa/search*
// @include http*://www.google.com.pa/webhp*
// @include http*://www.google.com.pe/
// @include http*://www.google.com.pe/search*
// @include http*://www.google.com.pe/webhp*
// @include http*://www.google.com.ph/
// @include http*://www.google.com.ph/search*
// @include http*://www.google.com.ph/webhp*
// @include http*://www.google.com.pk/
// @include http*://www.google.com.pk/search*
// @include http*://www.google.com.pk/webhp*
// @include http*://www.google.com.pr/
// @include http*://www.google.com.pr/search*
// @include http*://www.google.com.pr/webhp*
// @include http*://www.google.com.py/
// @include http*://www.google.com.py/search*
// @include http*://www.google.com.py/webhp*
// @include http*://www.google.com.qa/
// @include http*://www.google.com.qa/search*
// @include http*://www.google.com.qa/webhp*
// @include http*://www.google.com.sa/
// @include http*://www.google.com.sa/search*
// @include http*://www.google.com.sa/webhp*
// @include http*://www.google.com.sb/
// @include http*://www.google.com.sb/search*
// @include http*://www.google.com.sb/webhp*
// @include http*://www.google.com.sg/
// @include http*://www.google.com.sg/search*
// @include http*://www.google.com.sg/webhp*
// @include http*://www.google.com.sl/
// @include http*://www.google.com.sl/search*
// @include http*://www.google.com.sl/webhp*
// @include http*://www.google.com.sv/
// @include http*://www.google.com.sv/search*
// @include http*://www.google.com.sv/webhp*
// @include http*://www.google.com.tj/
// @include http*://www.google.com.tj/search*
// @include http*://www.google.com.tj/webhp*
// @include http*://www.google.com.tr/
// @include http*://www.google.com.tr/search*
// @include http*://www.google.com.tr/webhp*
// @include http*://www.google.com.tw/
// @include http*://www.google.com.tw/search*
// @include http*://www.google.com.tw/webhp*
// @include http*://www.google.com.ua/
// @include http*://www.google.com.ua/search*
// @include http*://www.google.com.ua/webhp*
// @include http*://www.google.com.uy/
// @include http*://www.google.com.uy/search*
// @include http*://www.google.com.uy/webhp*
// @include http*://www.google.com.vc/
// @include http*://www.google.com.vc/search*
// @include http*://www.google.com.vc/webhp*
// @include http*://www.google.com.vn/
// @include http*://www.google.com.vn/search*
// @include http*://www.google.com.vn/webhp*
// @include http*://www.google.cz/
// @include http*://www.google.cz/search*
// @include http*://www.google.cz/webhp*
// @include http*://www.google.de/
// @include http*://www.google.de/search*
// @include http*://www.google.de/webhp*
// @include http*://www.google.dj/
// @include http*://www.google.dj/search*
// @include http*://www.google.dj/webhp*
// @include http*://www.google.dk/
// @include http*://www.google.dk/search*
// @include http*://www.google.dk/webhp*
// @include http*://www.google.dm/
// @include http*://www.google.dm/search*
// @include http*://www.google.dm/webhp*
// @include http*://www.google.dz/
// @include http*://www.google.dz/search*
// @include http*://www.google.dz/webhp*
// @include http*://www.google.ee/
// @include http*://www.google.ee/search*
// @include http*://www.google.ee/webhp*
// @include http*://www.google.es/
// @include http*://www.google.es/search*
// @include http*://www.google.es/webhp*
// @include http*://www.google.fi/
// @include http*://www.google.fi/search*
// @include http*://www.google.fi/webhp*
// @include http*://www.google.fm/
// @include http*://www.google.fm/search*
// @include http*://www.google.fm/webhp*
// @include http*://www.google.fr/
// @include http*://www.google.fr/search*
// @include http*://www.google.fr/webhp*
// @include http*://www.google.ga/
// @include http*://www.google.ga/search*
// @include http*://www.google.ga/webhp*
// @include http*://www.google.ge/
// @include http*://www.google.ge/search*
// @include http*://www.google.ge/webhp*
// @include http*://www.google.gg/
// @include http*://www.google.gg/search*
// @include http*://www.google.gg/webhp*
// @include http*://www.google.gl/
// @include http*://www.google.gl/search*
// @include http*://www.google.gl/webhp*
// @include http*://www.google.gm/
// @include http*://www.google.gm/search*
// @include http*://www.google.gm/webhp*
// @include http*://www.google.gp/
// @include http*://www.google.gp/search*
// @include http*://www.google.gp/webhp*
// @include http*://www.google.gr/
// @include http*://www.google.gr/search*
// @include http*://www.google.gr/webhp*
// @include http*://www.google.gy/
// @include http*://www.google.gy/search*
// @include http*://www.google.gy/webhp*
// @include http*://www.google.hn/
// @include http*://www.google.hn/search*
// @include http*://www.google.hn/webhp*
// @include http*://www.google.hr/
// @include http*://www.google.hr/search*
// @include http*://www.google.hr/webhp*
// @include http*://www.google.ht/
// @include http*://www.google.ht/search*
// @include http*://www.google.ht/webhp*
// @include http*://www.google.hu/
// @include http*://www.google.hu/search*
// @include http*://www.google.hu/webhp*
// @include http*://www.google.ie/
// @include http*://www.google.ie/search*
// @include http*://www.google.ie/webhp*
// @include http*://www.google.im/
// @include http*://www.google.im/search*
// @include http*://www.google.im/webhp*
// @include http*://www.google.is/
// @include http*://www.google.is/search*
// @include http*://www.google.is/webhp*
// @include http*://www.google.it/
// @include http*://www.google.it/search*
// @include http*://www.google.it/webhp*
// @include http*://www.google.it.ao/
// @include http*://www.google.it.ao/search*
// @include http*://www.google.it.ao/webhp*
// @include http*://www.google.je/
// @include http*://www.google.je/search*
// @include http*://www.google.je/webhp*
// @include http*://www.google.jo/
// @include http*://www.google.jo/search*
// @include http*://www.google.jo/webhp*
// @include http*://www.google.kg/
// @include http*://www.google.kg/search*
// @include http*://www.google.kg/webhp*
// @include http*://www.google.ki/
// @include http*://www.google.ki/search*
// @include http*://www.google.ki/webhp*
// @include http*://www.google.kz/
// @include http*://www.google.kz/search*
// @include http*://www.google.kz/webhp*
// @include http*://www.google.la/
// @include http*://www.google.la/search*
// @include http*://www.google.la/webhp*
// @include http*://www.google.li/
// @include http*://www.google.li/search*
// @include http*://www.google.li/webhp*
// @include http*://www.google.lk/
// @include http*://www.google.lk/search*
// @include http*://www.google.lk/webhp*
// @include http*://www.google.lt/
// @include http*://www.google.lt/search*
// @include http*://www.google.lt/webhp*
// @include http*://www.google.lu/
// @include http*://www.google.lu/search*
// @include http*://www.google.lu/webhp*
// @include http*://www.google.lv/
// @include http*://www.google.lv/search*
// @include http*://www.google.lv/webhp*
// @include http*://www.google.md/
// @include http*://www.google.md/search*
// @include http*://www.google.md/webhp*
// @include http*://www.google.me/
// @include http*://www.google.me/search*
// @include http*://www.google.me/webhp*
// @include http*://www.google.mg/
// @include http*://www.google.mg/search*
// @include http*://www.google.mg/webhp*
// @include http*://www.google.mk/
// @include http*://www.google.mk/search*
// @include http*://www.google.mk/webhp*
// @include http*://www.google.ml/
// @include http*://www.google.ml/search*
// @include http*://www.google.ml/webhp*
// @include http*://www.google.mn/
// @include http*://www.google.mn/search*
// @include http*://www.google.mn/webhp*
// @include http*://www.google.ms/
// @include http*://www.google.ms/search*
// @include http*://www.google.ms/webhp*
// @include http*://www.google.mu/
// @include http*://www.google.mu/search*
// @include http*://www.google.mu/webhp*
// @include http*://www.google.mv/
// @include http*://www.google.mv/search*
// @include http*://www.google.mv/webhp*
// @include http*://www.google.mw/
// @include http*://www.google.mw/search*
// @include http*://www.google.mw/webhp*
// @include http*://www.google.ne/
// @include http*://www.google.ne/search*
// @include http*://www.google.ne/webhp*
// @include http*://www.google.nl/
// @include http*://www.google.nl/search*
// @include http*://www.google.nl/webhp*
// @include http*://www.google.no/
// @include http*://www.google.no/search*
// @include http*://www.google.no/webhp*
// @include http*://www.google.nr/
// @include http*://www.google.nr/search*
// @include http*://www.google.nr/webhp*
// @include http*://www.google.nu/
// @include http*://www.google.nu/search*
// @include http*://www.google.nu/webhp*
// @include http*://www.google.pl/
// @include http*://www.google.pl/search*
// @include http*://www.google.pl/webhp*
// @include http*://www.google.pn/
// @include http*://www.google.pn/search*
// @include http*://www.google.pn/webhp*
// @include http*://www.google.ps/
// @include http*://www.google.ps/search*
// @include http*://www.google.ps/webhp*
// @include http*://www.google.pt/
// @include http*://www.google.pt/search*
// @include http*://www.google.pt/webhp*
// @include http*://www.google.ro/
// @include http*://www.google.ro/search*
// @include http*://www.google.ro/webhp*
// @include http*://www.google.rs/
// @include http*://www.google.rs/search*
// @include http*://www.google.rs/webhp*
// @include http*://www.google.ru/
// @include http*://www.google.ru/search*
// @include http*://www.google.ru/webhp*
// @include http*://www.google.rw/
// @include http*://www.google.rw/search*
// @include http*://www.google.rw/webhp*
// @include http*://www.google.sc/
// @include http*://www.google.sc/search*
// @include http*://www.google.sc/webhp*
// @include http*://www.google.se/
// @include http*://www.google.se/search*
// @include http*://www.google.se/webhp*
// @include http*://www.google.sh/
// @include http*://www.google.sh/search*
// @include http*://www.google.sh/webhp*
// @include http*://www.google.si/
// @include http*://www.google.si/search*
// @include http*://www.google.si/webhp*
// @include http*://www.google.sk/
// @include http*://www.google.sk/search*
// @include http*://www.google.sk/webhp*
// @include http*://www.google.sm/
// @include http*://www.google.sm/search*
// @include http*://www.google.sm/webhp*
// @include http*://www.google.sn/
// @include http*://www.google.sn/search*
// @include http*://www.google.sn/webhp*
// @include http*://www.google.st/
// @include http*://www.google.st/search*
// @include http*://www.google.st/webhp*
// @include http*://www.google.td/
// @include http*://www.google.td/search*
// @include http*://www.google.td/webhp*
// @include http*://www.google.tg/
// @include http*://www.google.tg/search*
// @include http*://www.google.tg/webhp*
// @include http*://www.google.tk/
// @include http*://www.google.tk/search*
// @include http*://www.google.tk/webhp*
// @include http*://www.google.tl/
// @include http*://www.google.tl/search*
// @include http*://www.google.tl/webhp*
// @include http*://www.google.tm/
// @include http*://www.google.tm/search*
// @include http*://www.google.tm/webhp*
// @include http*://www.google.to/
// @include http*://www.google.to/search*
// @include http*://www.google.to/webhp*
// @include http*://www.google.tt/
// @include http*://www.google.tt/search*
// @include http*://www.google.tt/webhp*
// @include http*://www.google.vg/
// @include http*://www.google.vg/search*
// @include http*://www.google.vg/webhp*
// @include http*://www.google.vu/
// @include http*://www.google.vu/search*
// @include http*://www.google.vu/webhp*
// @include http*://www.google.ws/
// @include http*://www.google.ws/search*
// @include http*://www.google.ws/webhp*
// ==/UserScript==

(function ()
{ 
  var background;
  var results = [];
  var google_hosts = ['encrypted.google.com', 'www.google.ad', 'www.google.ae', 'www.google.am', 'www.google.as', 'www.google.at', 'www.google.az', 'www.google.ba', 'www.google.be', 'www.google.bf', 'www.google.bg', 'www.google.bi', 'www.google.bj', 'www.google.bs', 'www.google.by', 'www.google.ca', 'www.google.cat', 'www.google.cd', 'www.google.cf', 'www.google.cg', 'www.google.ch', 'www.google.ci', 'www.google.cl', 'www.google.cm', 'www.google.cn', 'www.google.co.bw', 'www.google.co.ck', 'www.google.co.cr', 'www.google.co.id', 'www.google.co.il', 'www.google.co.in', 'www.google.co.jp', 'www.google.co.ke', 'www.google.co.kr', 'www.google.co.ls', 'www.google.co.ma', 'www.google.co.mz', 'www.google.co.nz', 'www.google.co.th', 'www.google.co.tz', 'www.google.co.ug', 'www.google.co.uk', 'www.google.co.uz', 'www.google.co.ve', 'www.google.co.vi', 'www.google.co.za', 'www.google.co.zm', 'www.google.co.zw', 'www.google.com', 'www.google.com.af', 'www.google.com.ag', 'www.google.com.ai', 'www.google.com.ar', 'www.google.com.au', 'www.google.com.bd', 'www.google.com.bh', 'www.google.com.bn', 'www.google.com.bo', 'www.google.com.br', 'www.google.com.by', 'www.google.com.bz', 'www.google.com.co', 'www.google.com.cu', 'www.google.com.do', 'www.google.com.ec', 'www.google.com.eg', 'www.google.com.et', 'www.google.com.fj', 'www.google.com.gh', 'www.google.com.gi', 'www.google.com.gt', 'www.google.com.hk', 'www.google.com.jm', 'www.google.com.kh', 'www.google.com.kw', 'www.google.com.lb', 'www.google.com.ly', 'www.google.com.mt', 'www.google.com.mx', 'www.google.com.my', 'www.google.com.na', 'www.google.com.nf', 'www.google.com.ng', 'www.google.com.ni', 'www.google.com.np', 'www.google.com.om', 'www.google.com.pa', 'www.google.com.pe', 'www.google.com.ph', 'www.google.com.pk', 'www.google.com.pr', 'www.google.com.py', 'www.google.com.qa', 'www.google.com.sa', 'www.google.com.sb', 'www.google.com.sg', 'www.google.com.sl', 'www.google.com.sv', 'www.google.com.tj', 'www.google.com.tr', 'www.google.com.tw', 'www.google.com.ua', 'www.google.com.uy', 'www.google.com.vc', 'www.google.com.vn', 'www.google.cz', 'www.google.de', 'www.google.dj', 'www.google.dk', 'www.google.dm', 'www.google.dz', 'www.google.ee', 'www.google.es', 'www.google.fi', 'www.google.fm', 'www.google.fr', 'www.google.ga', 'www.google.ge', 'www.google.gg', 'www.google.gl', 'www.google.gm', 'www.google.gp', 'www.google.gr', 'www.google.gy', 'www.google.hn', 'www.google.hr', 'www.google.ht', 'www.google.hu', 'www.google.ie', 'www.google.im', 'www.google.is', 'www.google.it', 'www.google.it.ao', 'www.google.je', 'www.google.jo', 'www.google.kg', 'www.google.ki', 'www.google.kz', 'www.google.la', 'www.google.li', 'www.google.lk', 'www.google.lt', 'www.google.lu', 'www.google.lv', 'www.google.md', 'www.google.me', 'www.google.mg', 'www.google.mk', 'www.google.ml', 'www.google.mn', 'www.google.ms', 'www.google.mu', 'www.google.mv', 'www.google.mw', 'www.google.ne', 'www.google.nl', 'www.google.no', 'www.google.nr', 'www.google.nu', 'www.google.pl', 'www.google.pn', 'www.google.ps', 'www.google.pt', 'www.google.ro', 'www.google.rs', 'www.google.ru', 'www.google.rw', 'www.google.sc', 'www.google.se', 'www.google.sh', 'www.google.si', 'www.google.sk', 'www.google.sm', 'www.google.sn', 'www.google.st', 'www.google.td', 'www.google.tg', 'www.google.tk', 'www.google.tl', 'www.google.tm', 'www.google.to', 'www.google.tt', 'www.google.vg', 'www.google.vu', 'www.google.ws'];
  var check_interval;
  
  opera.extension.onmessage = function(event) {
    // id
    if(event.data['what'] == 'id') {
      switch(event.data['name']) {
        case 'background':
          background = event.source;
      }
      event.source.postMessage({what: 'id', name: 'userjs'});
    }
    
    if(event.source == background) {
      switch(event.data['what']) {
        case 'block hosts':
          block_search_results(event.data['list']);
          break;
        case 'unblock hosts':
          unblock_search_results(event.data['list']);
          break;
      }
    }
  }
  
  window.addEventListener('DOMContentLoaded', function() {
    try_process_search_results();
    
    // Poll the search page for changes, and if present, enable/process blocking.
    // I don't like using polling, however I couldn't find a reliable event
    // based solution.
    // The Google Chrome Personal Blocklist extension uses polling also, and it
    // is far better written than this one..
    check_interval = window.setInterval(try_process_search_results,500);
  }, false);
  
  function try_process_search_results() {
    var lis = document.querySelectorAll('li.g:not(.gsbfiltered)');
    
    if(lis.length > 0) {
      process_search_results(lis);
    }
  }
  
  function process_search_results(list_items) {
    var hosts_to_check = [];
    
    // compile list of unique search result hosts
    Array.prototype.forEach.call(list_items, function(li) {
      var a = li.querySelector('h3.r a');
      
      // mark search result as processed
      add_class(li, 'gsbfiltered');
      
      if(a) {
        var host;
        var result;
        
        // Google sometimes has links which are redirected via special urls:
        // google.tld/url?...&url=www.example.com
        // google.tld/...q=www.example.com
        // Remove these redirects; replace links with direct links
        if(google_hosts.some(function(host) { return host == a.hostname})) {
          var matches = /[&?](url|q)=([^&]+)/.exec(a.href)
          
          // Make sure we're in the right place
          if(matches && matches.length == 3 && /^\/url$/.test(a.pathname)) {
            a.href = decodeURIComponent(matches[2]);
          }
        }
        host = a.hostname;
        
        if(!hosts_to_check.some(function(h) { return h == host})) {
          hosts_to_check.push(host);
        }
        
        result = {
          element: li,
          host: host
        }
        results.push(result);
        
        add_block_links_to_search_result(result);
      }
    });
    
    // send list to backend to be checked against list of blocked domains
    if(hosts_to_check.length > 0) {
      background.postMessage({what: 'check hosts', hosts: hosts_to_check});
    }
  }
  
  // Removes search results with blocked hosts
  function block_search_results(hosts) {
    results.forEach(function(result) {
      if( hosts.some(function(host) { return host == result['host'] }) ) {
        result['display'] = result['element'].style.display;
        result['element'].style.display = 'none';
        add_class(result['element'],'blocked');
        result['blocked'] = true;
      }
    });
  }
  
  // Removes search results with blocked hosts
  function unblock_search_results(hosts) {
    results.forEach(function(result) {
      if( hosts.some(function(host) { return host == result['host'] }) ) {
        result['element'].style.display = result['display'];
        remove_class(result['element'],'blocked');
        result['blocked'] = false;
      }
    });
  }
  
  function add_block_links_to_search_result(result) {
    var cite = result['element'].querySelector('.s cite');
    var ablock = document.createElement('a');
    
    // Some types of results do not have a cite. Eg: an imagebox
    if(cite) {
      ablock.href = '#';
      ablock.onclick = on_block_result;
      ablock.textContent = 'block ' + result['host'];
      ablock.title = result['host'];
      
      cite.textContent += ' - ';
      cite.appendChild(ablock);
    }
  }
  
  function on_block_result(e) {
    e.stopPropagation();
    
    var li = find_element_parent(e.target, 'li');
    
    if(li) {
      var a = li.querySelector('h3.r a');
      background.postMessage({what: 'block host', host: a.hostname});
    }
    
    return false;
  }
  
  // ------ Utilities ---------
  
  // Finds the parent of an element of the type specified
  // params:
  //   element: start element
  //   parentType: nodeName of parent we are looking for
  function find_element_parent(element, parentType) {
    var parent = element.parentNode;
    var type = parentType.toUpperCase();
    
    while(parent != document) {
      if(parent.nodeName == type) return parent;
      parent = parent.parentNode;
    }
    return undefined;
  }
  
  function add_class(element, klass) {
    if(element.className && element.className.length > 0) {
      element.className += ' ';
    }
    element.className += klass;
  }
  function remove_class(element, klass) {
    element.className = 
      element.className.replace(RegExp('(?:^|\s)' + klass + '(?!\S)'), '');
  }
  function has_class(element, klass) {
    var re = RegExp('\\b' + klass + '\\b');
    return re.test(element.className);
  }
  
})();
